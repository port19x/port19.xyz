<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2022-09-17 Sat 18:50 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Data Processing with Clojure</title>
<meta name="author" content="port19" />
<meta name="generator" content="Org Mode" />
<link rel="stylesheet" type="text/css" href="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/css/readtheorg.css"/>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/src/lib/js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/js/readtheorg.js"></script>
</head>
<body>
<div id="content" class="content">
<h1 class="title">Data Processing with Clojure</h1>
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org0d229af">1. Problem Definition</a></li>
<li><a href="#org8a87d75">2. Project Setup and Dependencies</a></li>
<li><a href="#org3f6c67a">3. The raw data</a>
<ul>
<li><a href="#orged48597">3.1. /members</a></li>
<li><a href="#orgf991f86">3.2. /currentriverrace</a></li>
</ul>
</li>
<li><a href="#orgfd70ff7">4. Requesting and decoding the data</a>
<ul>
<li><a href="#orgb2eee00">4.1. Grabbing donations</a></li>
<li><a href="#org2da9d9b">4.2. Grabbing riverrace (aka war) stats</a></li>
</ul>
</li>
<li><a href="#orgf98c5f7">5. Merging the data</a>
<ul>
<li><a href="#orgf2630be">5.1. Getting our keys back</a></li>
<li><a href="#orgc3cb811">5.2. Merging</a></li>
<li><a href="#org1be1185">5.3. Making the data prettier</a></li>
<li><a href="#org254dbbf">5.4. Catching the edge case</a></li>
<li><a href="#org810d966">5.5. Tadaa</a></li>
</ul>
</li>
<li><a href="#org807ec65">6. Wrapping up</a></li>
<li><a href="#org4750c80">7. Full code</a></li>
</ul>
</div>
</div>

<div id="outline-container-org0d229af" class="outline-2">
<h2 id="org0d229af"><span class="section-number-2">1.</span> Problem Definition</h2>
<div class="outline-text-2" id="text-1">
<p>
A class of application that I quite enjoy writing is pulling data from some api endpoint and processing it to my benefit<br />
About two years ago I wrote a discord bot that pulled data from the Clash Royale API and based on that data displayed clan members to be promoted / demoted / kicked based on different thresholds for some performance / engagement indicators<br />
Clojure claims to be very good with data. Let&rsquo;s see that in action by rewriting that old code (minus the discord integration)<br />
</p>

<p>
A note on setup: I use doom emacs and cider for development and emacs org mode with code blocks and html export to write this document<br />
</p>
</div>
</div>

<div id="outline-container-org8a87d75" class="outline-2">
<h2 id="org8a87d75"><span class="section-number-2">2.</span> Project Setup and Dependencies</h2>
<div class="outline-text-2" id="text-2">
<p>
There are two main things we&rsquo;re gonna outsource to dependencies: json processing and http requests<br />
After a short period of searching on github I found the following two candidates<br />
</p>

<ul class="org-ul">
<li><a href="https://github.com/dakrone/clj-http#installation">clj-http</a><br /></li>
<li><a href="https://github.com/dakrone/cheshire#usage">cheshire</a><br /></li>
</ul>

<p>
Here is how my project.clj looks with both installed<br />
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #fe8019;">(</span><span style="color: #fb4934;">defproject</span> <span style="color: #b8bb26;">kicklistbot2</span> <span style="color: #b8bb26;">"0.1.0-SNAPSHOT"</span>
  <span style="color: #d3869b;">:description</span> <span style="color: #b8bb26;">"</span><span style="color: #fb4934; font-weight: bold;">FIXME:</span><span style="color: #b8bb26;"> write description"</span>
  <span style="color: #d3869b;">:url</span> <span style="color: #b8bb26;">"http://example.com/</span><span style="color: #fb4934; font-weight: bold;">FIXME</span><span style="color: #b8bb26;">"</span>
  <span style="color: #d3869b;">:license</span> <span style="color: #cc241d;">{</span><span style="color: #d3869b;">:name</span> <span style="color: #b8bb26;">"GPL-3.0"</span>
            <span style="color: #d3869b;">:url</span> <span style="color: #b8bb26;">"https://www.eclipse.org/legal/epl-2.0/"</span><span style="color: #cc241d;">}</span>
  <span style="color: #d3869b;">:dependencies</span> <span style="color: #cc241d;">[</span><span style="color: #b8bb26;">[</span><span style="color: #fabd2f;">org.clojure</span>/clojure <span style="color: #b8bb26;">"1.11.1"</span><span style="color: #b8bb26;">]</span>
                <span style="color: #b8bb26;">[</span>clj-http <span style="color: #b8bb26;">"3.12.3"</span><span style="color: #b8bb26;">]</span>
                <span style="color: #b8bb26;">[</span>cheshire <span style="color: #b8bb26;">"5.11.0"</span><span style="color: #b8bb26;">]</span><span style="color: #cc241d;">]</span>
  <span style="color: #d3869b;">:repl-options</span> <span style="color: #cc241d;">{</span><span style="color: #d3869b;">:init-ns</span> kicklistbot2.core<span style="color: #cc241d;">}</span><span style="color: #fe8019;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org3f6c67a" class="outline-2">
<h2 id="org3f6c67a"><span class="section-number-2">3.</span> The raw data</h2>
<div class="outline-text-2" id="text-3">
<p>
The test clan is called B Kindom and has the clan tag #JGLJR8L<br />
A full clan has 50 members, in the following I&rsquo;ll replace the repeating pattern with &#x2026; except for the first and last item in the large list<br />
For this to work we need to pull data from two enpoints of the clash royale api:<br />
</p>
</div>

<div id="outline-container-orged48597" class="outline-3">
<h3 id="orged48597"><span class="section-number-3">3.1.</span> /members</h3>
<div class="outline-text-3" id="text-3-1">
<p>
Relevant fields: &ldquo;name&rdquo; &ldquo;role&rdquo; &ldquo;donations&rdquo;<br />
</p>

<div class="org-src-container">
<pre class="src src-json">{
  <span style="color: #fb4934;">"items"</span>: [
    {
      <span style="color: #fb4934;">"tag"</span>: <span style="color: #b8bb26;">"#PQLPVJPJG"</span>,
      <span style="color: #fb4934;">"name"</span>: <span style="color: #b8bb26;">"&#12388;&#12400;&#12290;"</span>,
      <span style="color: #fb4934;">"role"</span>: <span style="color: #b8bb26;">"elder"</span>,
      <span style="color: #fb4934;">"lastSeen"</span>: <span style="color: #b8bb26;">"20220917T120523.000Z"</span>,
      <span style="color: #fb4934;">"expLevel"</span>: <span style="color: #d3869b; font-weight: bold;">14</span>,
      <span style="color: #fb4934;">"trophies"</span>: <span style="color: #d3869b; font-weight: bold;">6153</span>,
      <span style="color: #fb4934;">"arena"</span>: {
        <span style="color: #fb4934;">"id"</span>: <span style="color: #d3869b; font-weight: bold;">54000015</span>,
        <span style="color: #fb4934;">"name"</span>: <span style="color: #b8bb26;">"Master I"</span>
      },
      <span style="color: #fb4934;">"clanRank"</span>: <span style="color: #d3869b; font-weight: bold;">1</span>,
      <span style="color: #fb4934;">"previousClanRank"</span>: <span style="color: #d3869b; font-weight: bold;">1</span>,
      <span style="color: #fb4934;">"donations"</span>: <span style="color: #d3869b; font-weight: bold;">585</span>,
      <span style="color: #fb4934;">"donationsReceived"</span>: <span style="color: #d3869b; font-weight: bold;">424</span>,
      <span style="color: #fb4934;">"clanChestPoints"</span>: <span style="color: #d3869b; font-weight: bold;">0</span>
    },
      ...
    {
      <span style="color: #fb4934;">"tag"</span>: <span style="color: #b8bb26;">"#RJCUGJU"</span>,
      <span style="color: #fb4934;">"name"</span>: <span style="color: #b8bb26;">"~wonderland~"</span>,
      <span style="color: #fb4934;">"role"</span>: <span style="color: #b8bb26;">"member"</span>,
      <span style="color: #fb4934;">"lastSeen"</span>: <span style="color: #b8bb26;">"20220910T111416.000Z"</span>,
      <span style="color: #fb4934;">"expLevel"</span>: <span style="color: #d3869b; font-weight: bold;">14</span>,
      <span style="color: #fb4934;">"trophies"</span>: <span style="color: #d3869b; font-weight: bold;">4214</span>,
      <span style="color: #fb4934;">"arena"</span>: {
        <span style="color: #fb4934;">"id"</span>: <span style="color: #d3869b; font-weight: bold;">54000055</span>,
        <span style="color: #fb4934;">"name"</span>: <span style="color: #b8bb26;">"Arena 13"</span>
      },
      <span style="color: #fb4934;">"clanRank"</span>: <span style="color: #d3869b; font-weight: bold;">50</span>,
      <span style="color: #fb4934;">"previousClanRank"</span>: <span style="color: #d3869b; font-weight: bold;">50</span>,
      <span style="color: #fb4934;">"donations"</span>: <span style="color: #d3869b; font-weight: bold;">0</span>,
      <span style="color: #fb4934;">"donationsReceived"</span>: <span style="color: #d3869b; font-weight: bold;">0</span>,
      <span style="color: #fb4934;">"clanChestPoints"</span>: <span style="color: #d3869b; font-weight: bold;">0</span>
    }
  ],
  <span style="color: #fb4934;">"paging"</span>: {
    <span style="color: #fb4934;">"cursors"</span>: {}
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf991f86" class="outline-3">
<h3 id="orgf991f86"><span class="section-number-3">3.2.</span> /currentriverrace</h3>
<div class="outline-text-3" id="text-3-2">
<p>
Relevant fields: &ldquo;name&rdquo; &ldquo;decksUsed&rdquo; (within &ldquo;participants&rdquo;)<br />
</p>

<div class="org-src-container">
<pre class="src src-json">{
  <span style="color: #fb4934;">"state"</span>: <span style="color: #b8bb26;">"full"</span>,
  <span style="color: #fb4934;">"clan"</span>: {
    <span style="color: #fb4934;">"tag"</span>: <span style="color: #b8bb26;">"#JGLJR8L"</span>,
    <span style="color: #fb4934;">"name"</span>: <span style="color: #b8bb26;">"b kindom"</span>,
    <span style="color: #fb4934;">"badgeId"</span>: <span style="color: #d3869b; font-weight: bold;">16000010</span>,
    <span style="color: #fb4934;">"fame"</span>: <span style="color: #d3869b; font-weight: bold;">1952</span>,
    <span style="color: #fb4934;">"repairPoints"</span>: <span style="color: #d3869b; font-weight: bold;">0</span>,
    <span style="color: #fb4934;">"participants"</span>: [
      {
        <span style="color: #fb4934;">"tag"</span>: <span style="color: #b8bb26;">"#8PULQQVL"</span>,
        <span style="color: #fb4934;">"name"</span>: <span style="color: #b8bb26;">"SakeBRSP"</span>,
        <span style="color: #fb4934;">"fame"</span>: <span style="color: #d3869b; font-weight: bold;">0</span>,
        <span style="color: #fb4934;">"repairPoints"</span>: <span style="color: #d3869b; font-weight: bold;">0</span>,
        <span style="color: #fb4934;">"boatAttacks"</span>: <span style="color: #d3869b; font-weight: bold;">0</span>,
        <span style="color: #fb4934;">"decksUsed"</span>: <span style="color: #d3869b; font-weight: bold;">0</span>,
        <span style="color: #fb4934;">"decksUsedToday"</span>: <span style="color: #d3869b; font-weight: bold;">0</span>
      },
        ...
      {
        <span style="color: #fb4934;">"tag"</span>: <span style="color: #b8bb26;">"#98LQCGL0"</span>,
        <span style="color: #fb4934;">"name"</span>: <span style="color: #b8bb26;">"rweavere"</span>,
        <span style="color: #fb4934;">"fame"</span>: <span style="color: #d3869b; font-weight: bold;">2150</span>,
        <span style="color: #fb4934;">"repairPoints"</span>: <span style="color: #d3869b; font-weight: bold;">0</span>,
        <span style="color: #fb4934;">"boatAttacks"</span>: <span style="color: #d3869b; font-weight: bold;">2</span>,
        <span style="color: #fb4934;">"decksUsed"</span>: <span style="color: #d3869b; font-weight: bold;">13</span>,
        <span style="color: #fb4934;">"decksUsedToday"</span>: <span style="color: #d3869b; font-weight: bold;">4</span>
      }
    ],
    <span style="color: #fb4934;">"periodPoints"</span>: <span style="color: #d3869b; font-weight: bold;">5275</span>,
    <span style="color: #fb4934;">"clanScore"</span>: <span style="color: #d3869b; font-weight: bold;">2570</span>
  },
  <span style="color: #fb4934;">"clans"</span>: [
      _not interesting to us_
  ],
  <span style="color: #fb4934;">"sectionIndex"</span>: <span style="color: #d3869b; font-weight: bold;">1</span>,
  <span style="color: #fb4934;">"periodIndex"</span>: <span style="color: #d3869b; font-weight: bold;">12</span>,
  <span style="color: #fb4934;">"periodType"</span>: <span style="color: #b8bb26;">"warDay"</span>,
  <span style="color: #fb4934;">"periodLogs"</span>: [
      _also not interesting to us_
  ]
}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgfd70ff7" class="outline-2">
<h2 id="orgfd70ff7"><span class="section-number-2">4.</span> Requesting and decoding the data</h2>
<div class="outline-text-2" id="text-4">
</div>
<div id="outline-container-orgb2eee00" class="outline-3">
<h3 id="orgb2eee00"><span class="section-number-3">4.1.</span> Grabbing donations</h3>
<div class="outline-text-3" id="text-4-1">
<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #fe8019;">(</span><span style="color: #fb4934;">def</span> <span style="color: #83a598;">don</span>
    <span style="color: #cc241d;">(</span><span style="color: #fb4934;">-&gt;&gt;</span> <span style="color: #b8bb26;">(</span><span style="color: #d3869b;">:body</span> <span style="color: #83a598;">(</span><span style="color: #fabd2f;">client</span>/get <span style="color: #b8bb26;">"https://api.clashroyale.com/v1/clans/%23JGLJR8L/members"</span> <span style="color: #fe8019;">{</span><span style="color: #d3869b;">:headers</span> <span style="color: #cc241d;">{</span><span style="color: #d3869b;">:Authorization</span> <span style="color: #b8bb26;">(</span>str <span style="color: #b8bb26;">"Bearer "</span> <span style="color: #83a598;">(</span>slurp <span style="color: #b8bb26;">"token"</span><span style="color: #83a598;">)</span><span style="color: #b8bb26;">)</span><span style="color: #cc241d;">}</span><span style="color: #fe8019;">}</span><span style="color: #83a598;">)</span><span style="color: #b8bb26;">)</span>
         <span style="color: #b8bb26;">(</span>#<span style="color: #83a598;">(</span>decode <span style="color: #83a598;">%</span> <span style="color: #d3869b;">true</span><span style="color: #83a598;">)</span><span style="color: #b8bb26;">)</span>
         <span style="color: #b8bb26;">(</span><span style="color: #d3869b;">:items</span><span style="color: #b8bb26;">)</span>
         <span style="color: #b8bb26;">(</span>map #<span style="color: #83a598;">(</span>map <span style="color: #83a598;">%</span> <span style="color: #fe8019;">[</span><span style="color: #d3869b;">:name</span> <span style="color: #d3869b;">:role</span> <span style="color: #d3869b;">:donations</span><span style="color: #fe8019;">]</span><span style="color: #83a598;">)</span><span style="color: #b8bb26;">)</span>
    <span style="color: #cc241d;">)</span><span style="color: #fe8019;">)</span>
</pre>
</div>

<p>
Let&rsquo;s walk through this code snippet.<br />
</p>
<ul class="org-ul">
<li><code>(def don (...))</code> binds whatever we do next to the variable don, which we will continue to use later<br /></li>
<li><code>(-&gt;&gt; (x) (y) (z))</code> is called threadlast. It acts like a pipe, providing the output of (x) as the input of (y) and so forth.<br />
This can be seen as a more elegant shorthand to avoid ugly )))))))s<br />
<code>(-&gt;&gt; (x) (y) (z)</code> is equivalent to <code>(z (y (x)))</code><br /></li>
<li><code>(:body (client/get "https://api.clashroyale.com/v1/clans/%23JGLJR8L/members") ...)</code> is executing a get request on the members api endpoint and extracting the body of that request.<br />
Note we&rsquo;re not checking for the status. Good design would dictate checking it, but that can be done way later.<br /></li>
<li><code>(... {:headers {:Authorization (str "Bearer" (slurp "token"))}}))</code> Is setting up authorizaiton for the api. This is very specific per api, so check the api docs.<br />
Note <code>(slurp "token")</code>. This is a useful pattern for dealing with secrets on server side code. Just put the token into a file and read it at runtime. <code>slurp</code> reads the file <code>token</code>, which resides at the top level of our project directory<br /></li>
<li><code>(#(decode % true))</code> applies a lambda function to the input. we need to use a lambda function because the input should not be appended to the argument list but needs to squeeze between the &ldquo;decode&rdquo; and &ldquo;true&rdquo;.<br />
This is cheshire! And it&rsquo;s probably the only thing we&rsquo;re gonna use of it.<br /></li>
<li><code>(:items)</code> as you might guess, this returns the <code>(:items)</code> list from the now decoded json. These are our clan members.<br /></li>
<li><code>(map #(map % [:name :role :donations]))</code> This line of code took me embarassingly long to write. It makes sure to strip each members of his uninteresting properties, leaving only &ldquo;name&rdquo;, &ldquo;role&rdquo; and &ldquo;donations&rdquo;.<br />
This is why we have a double map. we map for each of the members.<br /></li>
</ul>
</div>
</div>

<div id="outline-container-org2da9d9b" class="outline-3">
<h3 id="org2da9d9b"><span class="section-number-3">4.2.</span> Grabbing riverrace (aka war) stats</h3>
<div class="outline-text-3" id="text-4-2">
<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #fe8019;">(</span><span style="color: #fb4934;">def</span> <span style="color: #83a598;">war</span>
   <span style="color: #cc241d;">(</span><span style="color: #fb4934;">-&gt;&gt;</span> <span style="color: #b8bb26;">(</span><span style="color: #d3869b;">:body</span> <span style="color: #83a598;">(</span><span style="color: #fabd2f;">client</span>/get <span style="color: #b8bb26;">"https://api.clashroyale.com/v1/clans/%23JGLJR8L/currentriverrace"</span> <span style="color: #fe8019;">{</span><span style="color: #d3869b;">:headers</span> <span style="color: #cc241d;">{</span><span style="color: #d3869b;">:Authorization</span> <span style="color: #b8bb26;">(</span>str <span style="color: #b8bb26;">"Bearer "</span> <span style="color: #83a598;">(</span>slurp <span style="color: #b8bb26;">"token"</span><span style="color: #83a598;">)</span><span style="color: #b8bb26;">)</span><span style="color: #cc241d;">}</span><span style="color: #fe8019;">}</span><span style="color: #83a598;">)</span><span style="color: #b8bb26;">)</span>
        <span style="color: #b8bb26;">(</span>#<span style="color: #83a598;">(</span>decode <span style="color: #83a598;">%</span> <span style="color: #d3869b;">true</span><span style="color: #83a598;">)</span><span style="color: #b8bb26;">)</span>
        <span style="color: #b8bb26;">(</span><span style="color: #d3869b;">:clan</span><span style="color: #b8bb26;">)</span>
        <span style="color: #b8bb26;">(</span><span style="color: #d3869b;">:participants</span><span style="color: #b8bb26;">)</span>
        <span style="color: #b8bb26;">(</span>map #<span style="color: #83a598;">(</span>map <span style="color: #83a598;">%</span> <span style="color: #fe8019;">[</span><span style="color: #d3869b;">:name</span> <span style="color: #d3869b;">:decksUsed</span><span style="color: #fe8019;">]</span><span style="color: #83a598;">)</span><span style="color: #b8bb26;">)</span>
   <span style="color: #cc241d;">)</span><span style="color: #fe8019;">)</span>
</pre>
</div>

<p>
Knowing what you know from the last section you should be able to figure out what this does on your own.<br />
</p>
</div>
</div>
</div>

<div id="outline-container-orgf98c5f7" class="outline-2">
<h2 id="orgf98c5f7"><span class="section-number-2">5.</span> Merging the data</h2>
<div class="outline-text-2" id="text-5">
<p>
Great! We can now conveniently check war statistics and donation statistics.<br />
But we want more! We want to check both at the same time. Time to get them into a more useful data structure.<br />
</p>
</div>

<div id="outline-container-orgf2630be" class="outline-3">
<h3 id="orgf2630be"><span class="section-number-3">5.1.</span> Getting our keys back</h3>
<div class="outline-text-3" id="text-5-1">
<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #fe8019;">(</span><span style="color: #fb4934;">def</span> <span style="color: #83a598;">dondic</span> <span style="color: #cc241d;">(</span>sort-by <span style="color: #d3869b;">:name</span> <span style="color: #b8bb26;">(</span>map #<span style="color: #83a598;">(</span>hash-map <span style="color: #d3869b;">:name</span> <span style="color: #fe8019;">(</span>first <span style="color: #83a598;">%</span><span style="color: #fe8019;">)</span> <span style="color: #d3869b;">:role</span> <span style="color: #fe8019;">(</span>second <span style="color: #83a598;">%</span><span style="color: #fe8019;">)</span> <span style="color: #d3869b;">:donations</span> <span style="color: #fe8019;">(</span>last <span style="color: #83a598;">%</span><span style="color: #fe8019;">)</span><span style="color: #83a598;">)</span> don<span style="color: #b8bb26;">)</span><span style="color: #cc241d;">)</span><span style="color: #fe8019;">)</span>
</pre>
</div>

<p>
Why don&rsquo;t we use a threadlast here?<br />
Well, because then it would be 3 lines: def, sort-by and mapping to hash-map.<br />
If we did one or two more things to it we would use threadlast, but in this case as oneliner is more ergonomic.<br />
</p>

<p>
When we reduced the dataset to just the relevant fields earlier, we lost the fields and now we can&rsquo;t elegantly index our data. To fix this we use <code>(map #(hash-map :name (first %) :role (second %) :donations (last %)) don)</code><br />
</p>

<p>
Then we sort by the name, just so output is less confusing when we check the repl later, and bind to dondic<br />
</p>

<p>
The war data suffers from the same problem and is fixed very similarly:<br />
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #fe8019;">(</span><span style="color: #fb4934;">def</span> <span style="color: #83a598;">wardic</span> <span style="color: #cc241d;">(</span>sort-by <span style="color: #d3869b;">:name</span> <span style="color: #b8bb26;">(</span>map #<span style="color: #83a598;">(</span>hash-map <span style="color: #d3869b;">:name</span> <span style="color: #fe8019;">(</span>first <span style="color: #83a598;">%</span><span style="color: #fe8019;">)</span> <span style="color: #d3869b;">:decks</span> <span style="color: #fe8019;">(</span>second <span style="color: #83a598;">%</span><span style="color: #fe8019;">)</span><span style="color: #83a598;">)</span> war<span style="color: #b8bb26;">)</span><span style="color: #cc241d;">)</span><span style="color: #fe8019;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc3cb811" class="outline-3">
<h3 id="orgc3cb811"><span class="section-number-3">5.2.</span> Merging</h3>
<div class="outline-text-3" id="text-5-2">
<p>
Since the two hashmaps are sorted by name you may be tempted to just merge dondic and wardic.<br />
With this api, especially due to new clan members, it sometimes happens that someone appears in the members endpoint but not yet in the riverrace endpoint. So instead we use an alternative workaround:<br />
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #fe8019;">(</span><span style="color: #fb4934;">def</span> <span style="color: #83a598;">finally</span> <span style="color: #cc241d;">(</span>group-by <span style="color: #d3869b;">:name</span> <span style="color: #b8bb26;">(</span>concat dondic wardic<span style="color: #b8bb26;">)</span><span style="color: #cc241d;">)</span><span style="color: #fe8019;">)</span>
</pre>
</div>

<p>
But we&rsquo;re not done. Now our data looks a bit weird.<br />
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #fe8019;">{</span><span style="color: #b8bb26;">"jj"</span> <span style="color: #cc241d;">[</span><span style="color: #b8bb26;">{</span><span style="color: #d3869b;">:role</span> elder, <span style="color: #d3869b;">:name</span> <span style="color: #b8bb26;">"jj"</span>, <span style="color: #d3869b;">:donations</span> <span style="color: #d3869b; font-weight: bold;">20</span><span style="color: #b8bb26;">}</span> <span style="color: #b8bb26;">{</span><span style="color: #d3869b;">:decks</span> <span style="color: #d3869b; font-weight: bold;">0</span>, <span style="color: #d3869b;">:name</span> <span style="color: #b8bb26;">"jj"</span><span style="color: #b8bb26;">}</span><span style="color: #cc241d;">]</span>, ...<span style="color: #fe8019;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org1be1185" class="outline-3">
<h3 id="org1be1185"><span class="section-number-3">5.3.</span> Making the data prettier</h3>
<div class="outline-text-3" id="text-5-3">
<p>
Sidenote: when working with such large sequences of data it can, especially when programming with a lisp, be very beneficial to first extract a sample entry to construct a working lambda function.<br />
So here I extracted my specimen and after a few different ideas I got one that worked for the normal case and didn&rsquo;t freak out about the non-standard cases.<br />
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #fe8019;">(</span><span style="color: #fb4934;">def</span> <span style="color: #83a598;">specimen</span> <span style="color: #cc241d;">(</span>second finally<span style="color: #cc241d;">)</span><span style="color: #fe8019;">)</span>
<span style="color: #fe8019;">(</span><span style="color: #fb4934;">def</span> <span style="color: #83a598;">speciale</span><span style="color: #cc241d;">(</span>#<span style="color: #b8bb26;">(</span>merge <span style="color: #83a598;">(</span>first <span style="color: #fe8019;">(</span>second <span style="color: #83a598;">%</span><span style="color: #fe8019;">)</span><span style="color: #83a598;">)</span> <span style="color: #83a598;">(</span>second <span style="color: #fe8019;">(</span>second <span style="color: #83a598;">%</span><span style="color: #fe8019;">)</span><span style="color: #83a598;">)</span><span style="color: #b8bb26;">)</span> specimen<span style="color: #cc241d;">)</span><span style="color: #fe8019;">)</span>
</pre>
</div>

<p>
Specimen after his fabolous operation: <code>{:role member, :decks 0, :name Twerk Lala, :donations 0}</code><br />
</p>
</div>
</div>

<div id="outline-container-org254dbbf" class="outline-3">
<h3 id="org254dbbf"><span class="section-number-3">5.4.</span> Catching the edge case</h3>
<div class="outline-text-3" id="text-5-4">
<p>
Now the keen eye may have noticed that I picked the second entry as my specimen.<br />
Choosing the first just gives me this: <code>{:role member, :name Beluga, :donations 76}</code><br />
</p>

<p>
Let&rsquo;s fix this guy up<br />
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #fe8019;">(</span>merge-with #<span style="color: #cc241d;">(</span>max <span style="color: #83a598;">%1</span> <span style="color: #83a598;">%2</span><span style="color: #cc241d;">)</span> speciale <span style="color: #cc241d;">{</span><span style="color: #d3869b;">:donations</span> <span style="color: #d3869b; font-weight: bold;">0</span>, <span style="color: #d3869b;">:decks</span> <span style="color: #d3869b; font-weight: bold;">0</span><span style="color: #cc241d;">}</span><span style="color: #fe8019;">)</span>
</pre>
</div>

<p>
Note that we can&rsquo;t simply merge because that may overwrite the fabolous record of more upstanding citizens!<br />
Instead we want to only set the respective keywords to zero if not already present, which this line achieves.<br />
</p>
</div>
</div>

<div id="outline-container-org810d966" class="outline-3">
<h3 id="org810d966"><span class="section-number-3">5.5.</span> Tadaa</h3>
<div class="outline-text-3" id="text-5-5">
<p>
Now let&rsquo;s bring it all together<br />
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #fe8019;">(</span><span style="color: #fb4934;">def</span> <span style="color: #83a598;">forge</span> <span style="color: #cc241d;">(</span>map #<span style="color: #b8bb26;">(</span>merge-with <span style="color: #83a598;">(</span><span style="color: #fb4934;">fn</span> <span style="color: #fe8019;">[</span>ra osiris<span style="color: #fe8019;">]</span> <span style="color: #fe8019;">(</span>max ra osiris<span style="color: #fe8019;">)</span><span style="color: #83a598;">)</span> <span style="color: #83a598;">%</span> <span style="color: #83a598;">{</span><span style="color: #d3869b;">:donations</span> <span style="color: #d3869b; font-weight: bold;">0</span>, <span style="color: #d3869b;">:decks</span> <span style="color: #d3869b; font-weight: bold;">0</span><span style="color: #83a598;">}</span><span style="color: #b8bb26;">)</span> <span style="color: #b8bb26;">(</span>map #<span style="color: #83a598;">(</span>merge <span style="color: #fe8019;">(</span>first <span style="color: #cc241d;">(</span>second <span style="color: #83a598;">%</span><span style="color: #cc241d;">)</span><span style="color: #fe8019;">)</span> <span style="color: #fe8019;">(</span>second <span style="color: #cc241d;">(</span>second <span style="color: #83a598;">%</span><span style="color: #cc241d;">)</span><span style="color: #fe8019;">)</span><span style="color: #83a598;">)</span> finally<span style="color: #b8bb26;">)</span><span style="color: #cc241d;">)</span><span style="color: #fe8019;">)</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org807ec65" class="outline-2">
<h2 id="org807ec65"><span class="section-number-2">6.</span> Wrapping up</h2>
<div class="outline-text-2" id="text-6">
<p>
Now we can have rather convenient kicklist generation:<br />
Consider we want to kick all members with less than 100 donations and less than 4 decks used.<br />
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #fe8019;">(</span>println <span style="color: #cc241d;">(</span>map <span style="color: #d3869b;">:name</span> <span style="color: #b8bb26;">(</span>filter #<span style="color: #83a598;">(</span><span style="color: #fb4934;">and</span> <span style="color: #fe8019;">(</span>= <span style="color: #b8bb26;">"member"</span> <span style="color: #cc241d;">(</span><span style="color: #d3869b;">:role</span> <span style="color: #83a598;">%</span><span style="color: #cc241d;">)</span><span style="color: #fe8019;">)</span> <span style="color: #fe8019;">(</span>&gt; <span style="color: #d3869b; font-weight: bold;">100</span> <span style="color: #cc241d;">(</span><span style="color: #d3869b;">:donations</span> <span style="color: #83a598;">%</span><span style="color: #cc241d;">)</span><span style="color: #fe8019;">)</span> <span style="color: #fe8019;">(</span>&gt; <span style="color: #d3869b; font-weight: bold;">8</span> <span style="color: #cc241d;">(</span><span style="color: #d3869b;">:decks</span> <span style="color: #83a598;">%</span><span style="color: #cc241d;">)</span><span style="color: #fe8019;">)</span><span style="color: #83a598;">)</span> forge<span style="color: #b8bb26;">)</span><span style="color: #cc241d;">)</span><span style="color: #fe8019;">)</span>
</pre>
</div>

<p>
Alternatively we may want to promote anyone who has used at least 8 decks and has 300 donations.<br />
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #fe8019;">(</span>println <span style="color: #cc241d;">(</span>map <span style="color: #d3869b;">:name</span> <span style="color: #b8bb26;">(</span>filter #<span style="color: #83a598;">(</span><span style="color: #fb4934;">and</span> <span style="color: #fe8019;">(</span>= <span style="color: #b8bb26;">"member"</span> <span style="color: #cc241d;">(</span><span style="color: #d3869b;">:role</span> <span style="color: #83a598;">%</span><span style="color: #cc241d;">)</span><span style="color: #fe8019;">)</span> <span style="color: #fe8019;">(</span>&lt; <span style="color: #d3869b; font-weight: bold;">300</span> <span style="color: #cc241d;">(</span><span style="color: #d3869b;">:donations</span> <span style="color: #83a598;">%</span><span style="color: #cc241d;">)</span><span style="color: #fe8019;">)</span> <span style="color: #fe8019;">(</span>&lt;= <span style="color: #d3869b; font-weight: bold;">8</span>  <span style="color: #cc241d;">(</span><span style="color: #d3869b;">:decks</span> <span style="color: #83a598;">%</span><span style="color: #cc241d;">)</span><span style="color: #fe8019;">)</span><span style="color: #83a598;">)</span> forge<span style="color: #b8bb26;">)</span><span style="color: #cc241d;">)</span><span style="color: #fe8019;">)</span>
</pre>
</div>

<p>
I hope this gave you a nice overview over clojure data processing or at least sparked your motivation to go crunch your own numbers<br />
</p>
</div>
</div>

<div id="outline-container-org4750c80" class="outline-2">
<h2 id="org4750c80"><span class="section-number-2">7.</span> Full code</h2>
<div class="outline-text-2" id="text-7">
<p>
<i>Note how I omitted the println from the last two lines so you can run the code block in org-mode</i><br />
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #fe8019;">(</span><span style="color: #fb4934;">ns</span> <span style="color: #fabd2f;">kicklistbot2.core</span>
  <span style="color: #cc241d;">(</span><span style="color: #d3869b;">:require</span> <span style="color: #b8bb26;">[</span>cheshire.core <span style="color: #d3869b;">:refer</span> <span style="color: #d3869b;">:all</span><span style="color: #b8bb26;">]</span><span style="color: #cc241d;">)</span>
  <span style="color: #cc241d;">(</span><span style="color: #d3869b;">:require</span> <span style="color: #b8bb26;">[</span>clj-http.client <span style="color: #d3869b;">:as</span> client<span style="color: #b8bb26;">]</span><span style="color: #cc241d;">)</span><span style="color: #fe8019;">)</span>

<span style="color: #fe8019;">(</span><span style="color: #fb4934;">def</span> <span style="color: #83a598;">don</span>
    <span style="color: #cc241d;">(</span><span style="color: #fb4934;">-&gt;&gt;</span> <span style="color: #b8bb26;">(</span><span style="color: #d3869b;">:body</span> <span style="color: #83a598;">(</span><span style="color: #fabd2f;">client</span>/get <span style="color: #b8bb26;">"https://api.clashroyale.com/v1/clans/%23JGLJR8L/members"</span> <span style="color: #fe8019;">{</span><span style="color: #d3869b;">:headers</span> <span style="color: #cc241d;">{</span><span style="color: #d3869b;">:Authorization</span> <span style="color: #b8bb26;">(</span>str <span style="color: #b8bb26;">"Bearer "</span> <span style="color: #83a598;">(</span>slurp <span style="color: #b8bb26;">"token"</span><span style="color: #83a598;">)</span><span style="color: #b8bb26;">)</span><span style="color: #cc241d;">}</span><span style="color: #fe8019;">}</span><span style="color: #83a598;">)</span><span style="color: #b8bb26;">)</span>
         <span style="color: #b8bb26;">(</span>#<span style="color: #83a598;">(</span>decode <span style="color: #83a598;">%</span> <span style="color: #d3869b;">true</span><span style="color: #83a598;">)</span><span style="color: #b8bb26;">)</span>
         <span style="color: #b8bb26;">(</span><span style="color: #d3869b;">:items</span><span style="color: #b8bb26;">)</span>
         <span style="color: #b8bb26;">(</span>map #<span style="color: #83a598;">(</span>map <span style="color: #83a598;">%</span> <span style="color: #fe8019;">[</span><span style="color: #d3869b;">:name</span> <span style="color: #d3869b;">:role</span> <span style="color: #d3869b;">:donations</span><span style="color: #fe8019;">]</span><span style="color: #83a598;">)</span><span style="color: #b8bb26;">)</span>
    <span style="color: #cc241d;">)</span><span style="color: #fe8019;">)</span>

  <span style="color: #fe8019;">(</span><span style="color: #fb4934;">def</span> <span style="color: #83a598;">war</span>
   <span style="color: #cc241d;">(</span><span style="color: #fb4934;">-&gt;&gt;</span> <span style="color: #b8bb26;">(</span><span style="color: #d3869b;">:body</span> <span style="color: #83a598;">(</span><span style="color: #fabd2f;">client</span>/get <span style="color: #b8bb26;">"https://api.clashroyale.com/v1/clans/%23JGLJR8L/currentriverrace"</span> <span style="color: #fe8019;">{</span><span style="color: #d3869b;">:headers</span> <span style="color: #cc241d;">{</span><span style="color: #d3869b;">:Authorization</span> <span style="color: #b8bb26;">(</span>str <span style="color: #b8bb26;">"Bearer "</span> <span style="color: #83a598;">(</span>slurp <span style="color: #b8bb26;">"token"</span><span style="color: #83a598;">)</span><span style="color: #b8bb26;">)</span><span style="color: #cc241d;">}</span><span style="color: #fe8019;">}</span><span style="color: #83a598;">)</span><span style="color: #b8bb26;">)</span>
        <span style="color: #b8bb26;">(</span>#<span style="color: #83a598;">(</span>decode <span style="color: #83a598;">%</span> <span style="color: #d3869b;">true</span><span style="color: #83a598;">)</span><span style="color: #b8bb26;">)</span>
        <span style="color: #b8bb26;">(</span><span style="color: #d3869b;">:clan</span><span style="color: #b8bb26;">)</span>
        <span style="color: #b8bb26;">(</span><span style="color: #d3869b;">:participants</span><span style="color: #b8bb26;">)</span>
        <span style="color: #b8bb26;">(</span>map #<span style="color: #83a598;">(</span>map <span style="color: #83a598;">%</span> <span style="color: #fe8019;">[</span><span style="color: #d3869b;">:name</span> <span style="color: #d3869b;">:decksUsed</span><span style="color: #fe8019;">]</span><span style="color: #83a598;">)</span><span style="color: #b8bb26;">)</span>
   <span style="color: #cc241d;">)</span><span style="color: #fe8019;">)</span>

<span style="color: #fe8019;">(</span><span style="color: #fb4934;">def</span> <span style="color: #83a598;">dondic</span> <span style="color: #cc241d;">(</span>sort-by <span style="color: #d3869b;">:name</span> <span style="color: #b8bb26;">(</span>map #<span style="color: #83a598;">(</span>hash-map <span style="color: #d3869b;">:name</span> <span style="color: #fe8019;">(</span>first <span style="color: #83a598;">%</span><span style="color: #fe8019;">)</span> <span style="color: #d3869b;">:role</span> <span style="color: #fe8019;">(</span>second <span style="color: #83a598;">%</span><span style="color: #fe8019;">)</span> <span style="color: #d3869b;">:donations</span> <span style="color: #fe8019;">(</span>last <span style="color: #83a598;">%</span><span style="color: #fe8019;">)</span><span style="color: #83a598;">)</span> don<span style="color: #b8bb26;">)</span><span style="color: #cc241d;">)</span><span style="color: #fe8019;">)</span>
<span style="color: #fe8019;">(</span><span style="color: #fb4934;">def</span> <span style="color: #83a598;">wardic</span> <span style="color: #cc241d;">(</span>sort-by <span style="color: #d3869b;">:name</span> <span style="color: #b8bb26;">(</span>map #<span style="color: #83a598;">(</span>hash-map <span style="color: #d3869b;">:name</span> <span style="color: #fe8019;">(</span>first <span style="color: #83a598;">%</span><span style="color: #fe8019;">)</span> <span style="color: #d3869b;">:decks</span> <span style="color: #fe8019;">(</span>second <span style="color: #83a598;">%</span><span style="color: #fe8019;">)</span><span style="color: #83a598;">)</span> war<span style="color: #b8bb26;">)</span><span style="color: #cc241d;">)</span><span style="color: #fe8019;">)</span>
<span style="color: #fe8019;">(</span><span style="color: #fb4934;">def</span> <span style="color: #83a598;">finally</span> <span style="color: #cc241d;">(</span>group-by <span style="color: #d3869b;">:name</span> <span style="color: #b8bb26;">(</span>concat dondic wardic<span style="color: #b8bb26;">)</span><span style="color: #cc241d;">)</span><span style="color: #fe8019;">)</span>
<span style="color: #fe8019;">(</span><span style="color: #fb4934;">def</span> <span style="color: #83a598;">forge</span> <span style="color: #cc241d;">(</span>map #<span style="color: #b8bb26;">(</span>merge-with <span style="color: #83a598;">(</span><span style="color: #fb4934;">fn</span> <span style="color: #fe8019;">[</span>ra osiris<span style="color: #fe8019;">]</span> <span style="color: #fe8019;">(</span>max ra osiris<span style="color: #fe8019;">)</span><span style="color: #83a598;">)</span> <span style="color: #83a598;">%</span> <span style="color: #83a598;">{</span><span style="color: #d3869b;">:donations</span> <span style="color: #d3869b; font-weight: bold;">0</span>, <span style="color: #d3869b;">:decks</span> <span style="color: #d3869b; font-weight: bold;">0</span><span style="color: #83a598;">}</span><span style="color: #b8bb26;">)</span> <span style="color: #b8bb26;">(</span>map #<span style="color: #83a598;">(</span>merge <span style="color: #fe8019;">(</span>first <span style="color: #cc241d;">(</span>second <span style="color: #83a598;">%</span><span style="color: #cc241d;">)</span><span style="color: #fe8019;">)</span> <span style="color: #fe8019;">(</span>second <span style="color: #cc241d;">(</span>second <span style="color: #83a598;">%</span><span style="color: #cc241d;">)</span><span style="color: #fe8019;">)</span><span style="color: #83a598;">)</span> finally<span style="color: #b8bb26;">)</span><span style="color: #cc241d;">)</span><span style="color: #fe8019;">)</span>

<span style="color: #fe8019;">(</span>map <span style="color: #d3869b;">:name</span> <span style="color: #cc241d;">(</span>filter #<span style="color: #b8bb26;">(</span><span style="color: #fb4934;">and</span> <span style="color: #83a598;">(</span>= <span style="color: #b8bb26;">"member"</span> <span style="color: #fe8019;">(</span><span style="color: #d3869b;">:role</span> <span style="color: #83a598;">%</span><span style="color: #fe8019;">)</span><span style="color: #83a598;">)</span> <span style="color: #83a598;">(</span>&gt; <span style="color: #d3869b; font-weight: bold;">100</span> <span style="color: #fe8019;">(</span><span style="color: #d3869b;">:donations</span> <span style="color: #83a598;">%</span><span style="color: #fe8019;">)</span><span style="color: #83a598;">)</span> <span style="color: #83a598;">(</span>&gt; <span style="color: #d3869b; font-weight: bold;">8</span> <span style="color: #fe8019;">(</span><span style="color: #d3869b;">:decks</span> <span style="color: #83a598;">%</span><span style="color: #fe8019;">)</span><span style="color: #83a598;">)</span><span style="color: #b8bb26;">)</span> forge<span style="color: #cc241d;">)</span><span style="color: #fe8019;">)</span>
<span style="color: #fe8019;">(</span>map <span style="color: #d3869b;">:name</span> <span style="color: #cc241d;">(</span>filter #<span style="color: #b8bb26;">(</span><span style="color: #fb4934;">and</span> <span style="color: #83a598;">(</span>= <span style="color: #b8bb26;">"member"</span> <span style="color: #fe8019;">(</span><span style="color: #d3869b;">:role</span> <span style="color: #83a598;">%</span><span style="color: #fe8019;">)</span><span style="color: #83a598;">)</span> <span style="color: #83a598;">(</span>&lt; <span style="color: #d3869b; font-weight: bold;">300</span> <span style="color: #fe8019;">(</span><span style="color: #d3869b;">:donations</span> <span style="color: #83a598;">%</span><span style="color: #fe8019;">)</span><span style="color: #83a598;">)</span> <span style="color: #83a598;">(</span>&lt;= <span style="color: #d3869b; font-weight: bold;">8</span>  <span style="color: #fe8019;">(</span><span style="color: #d3869b;">:decks</span> <span style="color: #83a598;">%</span><span style="color: #fe8019;">)</span><span style="color: #83a598;">)</span><span style="color: #b8bb26;">)</span> forge<span style="color: #cc241d;">)</span><span style="color: #fe8019;">)</span>
</pre>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: port19</p>
<p class="date">Created: 2022-09-17 Sat 18:50</p>
</div>
</body>
</html>
